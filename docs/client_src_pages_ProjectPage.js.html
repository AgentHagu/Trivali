<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: client/src/pages/ProjectPage.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: client/src/pages/ProjectPage.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// React and 
import { useEffect, useRef, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";

// Components
import HeaderNavbar from "../components/HeaderNavbar";
import About from "../components/About";
import Expenses from "../components/Expenses";
import Itinerary from "../components/Itinerary";

// Custom Hooks
import useUserData from "../hooks/useUserData";

// Libraries
import { io } from "socket.io-client";
import { toast } from "react-toastify";
import { BudgetsProvider } from "../context/BudgetsContext";

const SERVER_URL = process.env.REACT_APP_API_URL;

/**
 * SearchBar component for adding users to a project.
 * Handles user search, validation, and addition/removal.
 *
 * @param {Object} props - Component props.
 * @param {SocketIO.Socket} props.socket - Socket instance for real-time communication.
 * @param {Object} props.currUser - Current user object.
 * @param {Array} props.addedUsersList - List of users already added to the project.
 * @param {Function} props.setAddedUsersList - Function to update the addedUsersList state.
 * @returns {JSX.Element} - SearchBar component JSX.
 */
function SearchBar({ socket, currUser, addedUsersList, setAddedUsersList }) {
    const [userValidity, setUserValidity] = useState(true)
    const [invalidMessage, setInvalidMessage] = useState("")

    /**
     * Converts a full user object to a simplified user object for storage.
     * @param {Object} user - Full user object.
     * @returns {Object} Simplified user object containing _id, username, and email.
     */
    function userToSimpleUser(user) {
        const simpleUser = {
            _id: user._id,
            username: user.username,
            email: user.email
        }

        return simpleUser
    }

    /**
     * Handles the search form submission.
     * Emits a 'search-user' event to the server with the search query.
     * @param {Event} e - Form submit event.
     */
    function searchHandler(e) {
        e.preventDefault()
        const userSearch = e.target[0].value

        socket.emit("search-user", userSearch)
    }

    useEffect(() => {
        /**
         * Handles the 'found-user' event from the server.
         * Validates the found user and updates the addedUsersList state if valid.
         * @param {Object} user - Found user object or null if not found.
         */
        const handleUserFound = user => {
            if (user == null) {
                setUserValidity(false)
                setInvalidMessage("No such user found")
                return
            }

            if (user._id === currUser._id) {
                setUserValidity(false)
                setInvalidMessage("You have already been added")
                return
            }

            const isUserInArray = addedUsersList.some(addedUser =>
                addedUser._id === user._id
            )

            if (!isUserInArray) {
                setUserValidity(true)
                setInvalidMessage("")
                const newList = [...addedUsersList, user]
                setAddedUsersList(newList)
                socket.emit("add-user", userToSimpleUser(user))

            } else {
                setUserValidity(false)
                setInvalidMessage("User has already been added")
            }
        }

        socket.on("found-user", handleUserFound)

        return () => {
            socket.off("found-user", handleUserFound)
        }
    }, [socket, addedUsersList, currUser, setAddedUsersList])

    /**
     * Removes a user from the addedUsersList state and emits a 'remove-user' event to the server.
     * @param {Object} simpleUser - Simplified user object to be removed.
     */
    function removeUserHandler(simpleUser) {
        const newList = addedUsersList.filter(addedUser => addedUser._id !== simpleUser._id)
        setAddedUsersList(newList)
        socket.emit("remove-user", simpleUser)
    }

    return &lt;>
        &lt;form className="mb-3" onSubmit={searchHandler}>
            &lt;label htmlFor="addUsers" className="form-label">Add Users to Project&lt;/label>
            &lt;div className="input-group has-validation">
                &lt;input
                    type="search"
                    className={`form-control me-2 
                        ${userValidity ? '' : 'is-invalid'}`}
                    id="addUsers"
                    placeholder="Search with ID or Email"
                />
                &lt;button className="btn btn-outline-primary" type="submit">
                    &lt;i className="bi bi-search" />
                &lt;/button>
                &lt;div className="invalid-feedback">
                    {invalidMessage}
                &lt;/div>
            &lt;/div>
        &lt;/form>

        {addedUsersList.length > 0
            ? &lt;>
                &lt;label className="form-label">Added Users&lt;/label>
                &lt;ul className="list-group">
                    {addedUsersList.map(user => (
                        &lt;li className="list-group-item d-flex justify-content-between align-items-center" key={user._id}>
                            &lt;span>
                                {user.username} (Email: {user.email})
                            &lt;/span>
                            {
                                user._id !== currUser._id
                                    ? &lt;button
                                        className="btn ms-auto p-0"
                                        onClick={() => removeUserHandler(user)}
                                    >
                                        &lt;i className="bi bi-person-fill-dash" />
                                    &lt;/button>
                                    : &lt;>Owner&lt;/>
                            }
                        &lt;/li>
                    ))}
                &lt;/ul>
            &lt;/>
            : &lt;>
                &lt;label className="form-label">No added Users&lt;/label>
            &lt;/>
        }

    &lt;/>
}


/**
 * Main component for managing a project, including its details and related functionalities.
 * Manages project loading, socket connections, user permissions, and dynamic content rendering.
 *
 * @returns {JSX.Element} - ProjectPage component JSX.
 */
export default function ProjectPage() {
    const { user, loading } = useUserData()
    const { id } = useParams()
    const projectIdRef = useRef(id)
    const [content, setContent] = useState(&lt;h1>Loading...&lt;/h1>)
    const [socket, setSocket] = useState()
    const [project, setProject] = useState()
    const [projectLoading, setProjectLoading] = useState(true)
    const navigate = useNavigate()
    const [addedUsersList, setAddedUsersList] = useState([])

    // Establish socket connection with server
    useEffect(() => {
        const s = io(`${SERVER_URL}`)
        setSocket(s)

        return () => {
            s.disconnect()
        }
    }, [])

    // Load project data from the server and handle initial setup
    useEffect(() => {
        if (socket == null || loading) return

        socket.once("load-project", project => {
            // Regardless of outcome, setProject and setProjectLoading
            setProject(project)
            setProjectLoading(false)

            // if project is null, i.e. it doesn't exist, go to home page
            // Otherwise, it exists and we can refer to its properties
            if (project == null) {
                toast.error("No such project exists! Redirecting to home page...", {
                    position: "top-center",
                    autoClose: 3000
                })
                navigate('/home')
                return
            }

            // Check user's permission to access the project
            if (!loading &amp;&amp; !project.userList.some(addedUser =>
                addedUser._id === user._id)) {
                toast.error("You don't have access to this project. Redirecting to home page...", {
                    position: "top-center",
                    autoClose: 3000
                })
                navigate('/home')
            }

            // Set initial content based on project data
            setContent(&lt;About data={project.about} />)
            setAddedUsersList(project.userList)
        })

        if (!loading &amp;&amp; user) {
            socket.emit("get-project", projectIdRef.current)
        }
    }, [socket, loading, user, navigate])

    /**
     * Handles changes to the project name and emits the change to the server.
     * @param {Event} event - Input change event.
     */
    function changeNameHandler(event) {
        socket.emit("change-project-name", event.target.value)
    }

    /**
     * Deletes the project after confirming with the user.
     */
    function deleteProjectHandler(event) {
        if (window.confirm("Are you sure you want to delete your project? All progress will be lost")) {
            socket.emit("delete-project")
            navigate('/home')
        }
    }

    // useEffect(() => {
    //     if (socket == null) return

    //     socket.on("kick-user", simpleUser => {
    //         // console.log("TRYING TO KICK USER -----")
    //         // console.log("USER TO KICK: ", simpleUser._id)
    //         // console.log("CURRENT USER: ", user._id)
    //         // if (simpleUser._id === user._id) {
    //         //     console.log("HEY")
    //         //     toast.error("You don't have access to this project. Redirecting to home page...", {
    //         //         //position: toast.POSITION.TOP_CENTER,
    //         //         autoClose: 3000
    //         //     })
    //         //     navigate('/home')
    //         // }

    //         toast.error("You don't have access to this project. Redirecting to home page...", {
    //             //position: toast.POSITION.TOP_CENTER,
    //             autoClose: 3000
    //         })
    //         navigate('/home')
    //     })
    // }, [loading, navigate, project, socket, user])

    /**
     * Switches the displayed content based on user selection.
     * @param {JSX.Element} newContent - New content to display.
     */
    const switchContent = (newContent) => () => {
        setContent(newContent)
    }

    // Render loading indicator while fetching project data
    if (project == null) {
        if (loading) {
            return &lt;>
                &lt;HeaderNavbar />
                &lt;div className="container mt-3 d-flex justify-content-center align-items-center vh-100">
                    &lt;div className="text-center">
                        &lt;div className="spinner-border" role="status">
                            &lt;span className="visually-hidden">Loading...&lt;/span>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            &lt;/>
        }

        if (projectLoading) {
            return &lt;>
                &lt;HeaderNavbar />
                &lt;div className="container mt-3 d-flex justify-content-center align-items-center vh-100">
                    &lt;div className="text-center">
                        &lt;div className="spinner-border" role="status">
                            &lt;span className="visually-hidden">Loading...&lt;/span>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            &lt;/>
        }

        return
    }

    // Render the main project page once project data is loaded
    return (
        &lt;>
            &lt;BudgetsProvider>
                &lt;HeaderNavbar />
                &lt;div className="container mt-3">
                    &lt;div className="row">
                        &lt;div className="col">
                            {
                                !project.name
                                    ? &lt;h1>Untitled Project&lt;/h1>
                                    : &lt;h1>{project.name}&lt;/h1>
                            }
                        &lt;/div>

                        {/* Only render the manage user button for the owner */}
                        {/* TODO: Have it exist for the admins as well */}
                        {
                            project.owner._id === user._id
                                ? &lt;div className="col d-flex">
                                    &lt;button type="button" className="btn btn-primary ms-auto fs-4" data-bs-toggle="modal" data-bs-target="#manageUsersModal">
                                        Manage Project
                                    &lt;/button>
                                &lt;/div>
                                : &lt;>&lt;/>
                        }

                    &lt;/div>

                    &lt;div className="row row-cols-2 mt-3">
                        &lt;div className="btn-group btn-group-lg" role="group">
                            &lt;button
                                className="btn btn-outline-dark rounded-0 border-bottom-0 border-2 border-dark"
                                onClick={switchContent(&lt;About projectId={projectIdRef.current} data={project.about} socket={socket} />)} >
                                About
                            &lt;/button>

                            &lt;button
                                className="btn btn-outline-dark rounded-0 border-bottom-0 border-2 border-dark"
                                onClick={switchContent(&lt;Itinerary projectId={projectIdRef.current} data={project.itinerary} socket={socket} />)} >
                                Itinerary
                            &lt;/button>

                            &lt;button
                                className="btn btn-outline-dark rounded-0 border-bottom-0 border-2 border-dark"
                                onClick={switchContent(&lt;Expenses projectId={projectIdRef.current} data={project.expenses} socket={socket} />)} >
                                Expenses
                            &lt;/button>
                        &lt;/div>
                    &lt;/div>

                    &lt;div className="border border-2 border-dark bg-white">
                        {content}
                    &lt;/div>
                &lt;/div>

                {/* Create Project Modal Form */}
                &lt;div className="modal fade" id="manageUsersModal" data-bs-keyboard="false" tabIndex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    &lt;div className="modal-dialog modal-dialog-centered">
                        &lt;div className="modal-content">
                            &lt;div className="modal-header">
                                &lt;h5 className="modal-title" id="exampleModalLabel">Manage Users&lt;/h5>
                                &lt;button type="button" className="btn-close" data-bs-dismiss="modal">&lt;/button>
                            &lt;/div>

                            &lt;div className="modal-body">
                                &lt;form id="createProjectForm">
                                    &lt;div className="mb-3">
                                        &lt;label htmlFor="projectName" className="form-label">Project Name&lt;/label>
                                        &lt;input type="text" className="form-control" id="projectName" placeholder="Enter a name for your project" value={project.name} onChange={(e) => setProject({ ...project, name: e.target.value })} onBlur={changeNameHandler} />
                                    &lt;/div>
                                &lt;/form>

                                &lt;SearchBar socket={socket} currUser={user} addedUsersList={addedUsersList} setAddedUsersList={setAddedUsersList} />
                            &lt;/div>

                            &lt;div className="modal-footer">
                                &lt;button type="button" className="btn btn-danger" data-bs-dismiss="modal" onClick={deleteProjectHandler}>Delete Project&lt;/button>
                            &lt;/div>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            &lt;/BudgetsProvider>
        &lt;/>
    )
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#App">App</a></li><li><a href="global.html#PrivateRoute">PrivateRoute</a></li><li><a href="global.html#SearchBar">SearchBar</a></li><li><a href="global.html#Table">Table</a></li><li><a href="global.html#checkAuthenticated">checkAuthenticated</a></li><li><a href="global.html#checkNotAuthenticated">checkNotAuthenticated</a></li><li><a href="global.html#defaultValue">defaultValue</a></li><li><a href="global.html#findOrCreateDocument">findOrCreateDocument</a></li><li><a href="global.html#findOrCreateProject">findOrCreateProject</a></li><li><a href="global.html#getProgressBarVariant">getProgressBarVariant</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#userToSimpleUser">userToSimpleUser</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Thu Jun 27 2024 22:03:07 GMT+0800 (Singapore Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
